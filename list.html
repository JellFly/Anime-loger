<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineNote - Ma Biblioth√®que</title>
    <link rel="stylesheet" href="style.css">
</head>
<script type="module">
import { initializeApp, getApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDWbsbfnF5e-E3rCMguVFF69PpAM-ZlAZ4",
  authDomain: "anime-lo.firebaseapp.com",
  projectId: "anime-lo",
  storageBucket: "anime-lo.firebasestorage.app",
  messagingSenderId: "424542474390",
  appId: "1:424542474390:web:2c28714a4c4f0178daf2b7"
};

try {
  let app;
  try {
    app = getApp();
  } catch(e) {
    app = initializeApp(firebaseConfig);
  }
  const auth = getAuth(app);
  const db = getFirestore(app);

  window.auth = auth;
  window.db = db;
  console.log("‚úÖ Firebase initialis√©");

  window.register = async function(email, password) {
    try {
      await createUserWithEmailAndPassword(auth, email, password);
      try {
        await setDoc(doc(db, "users", auth.currentUser.uid), {
          profiles: [{
            name: "Profil 1",
            avatar: "https://via.placeholder.com/100",
            bio: "",
            animes: [],
            films: [],
            series: [],
            watch: []
          }],
          currentProfileIndex: 0
        });
      } catch(dbError) {
        console.log("Firebase Firestore indisponible, utilisation du stockage local");
        localStorage.setItem("profiles", JSON.stringify([{
          name: "Profil 1",
          avatar: "https://via.placeholder.com/100",
          bio: "",
          animes: [],
          films: [],
          series: [],
          watch: []
        }]));
        localStorage.setItem("currentProfileIndex", "0");
      }
      alert("Compte cr√©√© ! Veuillez compl√©ter votre profil.");
      window.closeAuthModal();
      window.location.href = "profile-setup.html";
    } catch(e) {
      alert("Erreur: " + e.message);
    }
  };

  window.login = async function(email, password) {
    try {
      await signInWithEmailAndPassword(auth, email, password);
      alert("Connect√© !");
      window.closeAuthModal();
      if(window.loadProfilesFromFirebase) window.loadProfilesFromFirebase();
    } catch(e) {
      alert("Erreur: " + e.message);
    }
  };

  window.logout = async function() {
    try {
      await signOut(auth);
      alert("D√©connect√©");
      window.updateAuthIcon();
    } catch(e) {
      alert("Erreur: " + e.message);
    }
  };

  window.loadUserData = async function() {
    if(!auth.currentUser) {
      console.log("Utilisateur non connect√©");
      return;
    }
    try {
      const ref = doc(db, "users", auth.currentUser.uid);
      const snap = await getDoc(ref);
      if(snap.exists()) {
        window.userDataFromFirebase = snap.data();
        console.log("Donn√©es charg√©es:", window.userDataFromFirebase);
        if(window.loadProfilesFromFirebase) window.loadProfilesFromFirebase();
      }
    } catch(e) {
      console.error("Erreur chargement:", e);
    }
  };

  onAuthStateChanged(auth, (user) => {
    if(user) {
      console.log("Utilisateur connect√©:", user.email);
      window.loadUserData();
      window.updateAuthIcon();
    } else {
      console.log("Utilisateur d√©connect√©");
      window.updateAuthIcon();
      setTimeout(() => {
        if(window.loadProfilesFromFirebase) {
          window.loadProfilesFromFirebase();
        }
      }, 500);
    }
  });

  // Fonctions UI d'authentification
  window.openAuthModal = function() {
    const modal = document.getElementById("authModal");
    if(modal) modal.classList.add("active");
  };

  window.closeAuthModal = function() {
    const modal = document.getElementById("authModal");
    if(modal) modal.classList.remove("active");
  };

  window.switchAuthTab = function(tab) {
    const loginForm = document.getElementById("loginForm");
    const registerForm = document.getElementById("registerForm");
    const authTitle = document.getElementById("authTitle");
    const buttons = document.querySelectorAll(".modal-content .tab-btn");
    
    buttons.forEach(btn => btn.classList.remove("active"));
    
    if(tab === "login") {
      if(loginForm) loginForm.style.display = "block";
      if(registerForm) registerForm.style.display = "none";
      if(authTitle) authTitle.textContent = "Se connecter";
      if(buttons[0]) buttons[0].classList.add("active");
    } else {
      if(loginForm) loginForm.style.display = "none";
      if(registerForm) registerForm.style.display = "block";
      if(authTitle) authTitle.textContent = "Cr√©er un compte";
      if(buttons[1]) buttons[1].classList.add("active");
    }
  };

  window.toggleAuthOrProfile = function() {
    if(window.auth && window.auth.currentUser) {
      window.openProfileModal();
    } else {
      window.openAuthModal();
    }
  };

  window.openProfileModal = function() {
    const p = window.profiles ? window.profiles[window.currentProfileIndex] : null;
    if(!p) return;
    
    const avatar = document.getElementById("profileModalAvatar");
    const name = document.getElementById("profileModalName");
    const email = document.getElementById("profileModalEmail");
    const bio = document.getElementById("profileModalBio");
    
    if(avatar) avatar.src = p.avatar;
    if(name) name.textContent = p.name;
    if(email) email.textContent = window.auth && window.auth.currentUser ? window.auth.currentUser.email : "Non connect√©";
    if(bio) bio.textContent = p.bio || "Aucune bio";
    
    const modal = document.getElementById("profileModal");
    if(modal) modal.classList.add("active");
  };

  window.closeProfileModal = function() {
    const modal = document.getElementById("profileModal");
    if(modal) modal.classList.remove("active");
  };

  window.updateAuthIcon = function() {
    const icon = document.getElementById("authIcon");
    if(!icon) return;
    if(window.auth && window.auth.currentUser) {
      icon.textContent = "‚úÖ";
      icon.title = window.auth.currentUser.email;
    } else {
      icon.textContent = "üë§";
      icon.title = "Cliquez pour vous connecter";
    }
  };
} catch(e) {
  console.error("‚ùå Erreur Firebase:", e);
  window.auth = null;
  window.db = null;
}
</script>
<body>

<header>
    <div>
        <h1>üé¨ CineNote</h1>
    </div>
    <nav>
        <a href="index.html">Accueil</a>
        <a href="search.html">üîç Recherche</a>
        <a href="list.html">Ma Biblioth√®que</a>
        <a href="watchlist.html">‚è≥ Watchlist</a>
        <a href="about.html">√Ä propos</a>
    </nav>
    <div class="header-right">
        <div class="auth-icon" onclick="window.openAuthModal()" id="authIcon">üë§</div>
    </div>
</header>

<!-- Profile Modal -->
<div class="modal" id="profileModal">
    <div class="modal-content" style="max-width: 500px;">
        <button class="modal-close" onclick="window.closeProfileModal()">&times;</button>
        <h2>üë§ Mon Profil</h2>
        
        <div style="text-align: center; margin: 30px 0;">
            <img id="profileModalAvatar" src="" alt="Avatar" style="width: 100px; height: 100px; border-radius: 50%; object-fit: cover; border: 3px solid var(--primary);">
            <h3 id="profileModalName" style="margin-top: 16px; margin-bottom: 8px;">Nom</h3>
            <p id="profileModalEmail" style="color: var(--text-muted); margin-bottom: 16px;">email@example.com</p>
            <p id="profileModalBio" style="color: var(--text-muted); font-style: italic; margin-bottom: 20px;">Bio</p>
        </div>
        
        <button class="btn-secondary" onclick="window.logout()" style="width: 100%; margin-bottom: 12px;">üö™ Se d√©connecter</button>
        <button class="btn-secondary" onclick="window.closeProfileModal()" style="width: 100%;">Fermer</button>
    </div>
</div>

<!-- Auth Modal -->
<div class="modal" id="authModal">
    <div class="modal-content">
        <button class="modal-close" onclick="window.closeAuthModal()">&times;</button>
        <h2 id="authTitle">Se connecter</h2>
        <div style="display: flex; gap: 12px; margin-bottom: 20px;">
            <button class="tab-btn active" onclick="window.switchAuthTab('login')" style="flex: 1;">Connexion</button>
            <button class="tab-btn" onclick="window.switchAuthTab('register')" style="flex: 1;">Inscription</button>
        </div>
        <div id="loginForm">
            <input id="email" type="email" placeholder="Email" style="margin-bottom: 12px;">
            <input id="pass" type="password" placeholder="Mot de passe" style="margin-bottom: 12px;">
            <button class="btn-primary" onclick="window.login(document.getElementById('email').value, document.getElementById('pass').value)">Se connecter</button>
        </div>
        <div id="registerForm" style="display: none;">
            <input id="emailReg" type="email" placeholder="Email" style="margin-bottom: 12px;">
            <input id="passReg" type="password" placeholder="Mot de passe" style="margin-bottom: 12px;">
            <input id="passRegConfirm" type="password" placeholder="Confirmer le mot de passe" style="margin-bottom: 12px;">
            <button class="btn-primary" onclick="window.register(document.getElementById('emailReg').value, document.getElementById('passReg').value)">Cr√©er un compte</button>
        </div>
    </div>
</div>

<main>
<section>
    <h2>üìö Ma Biblioth√®que</h2>
    <p style="color: var(--text-muted); margin-bottom: 24px;">Tous les titres que tu as regard√©s</p>
    
    <!-- FILTRES -->
    <div style="background: var(--bg-lighter); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 24px;">
        <h3 style="margin-top: 0;">üîç Filtres et Tri</h3>
        
        <!-- Recherche -->
        <div class="form-group">
            <label for="search">Rechercher</label>
            <input id="search" type="text" placeholder="Rechercher un titre..." oninput="render()" style="margin-bottom: 0;">
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px; margin-top: 16px;">
            <!-- Type Filter -->
            <div class="form-group" style="margin-bottom: 0;">
                <label for="filterType">Filtrer par type</label>
                <select id="filterType" onchange="render()" style="margin-bottom: 0;">
                    <option value="tout">üì∫ Tous les types</option>
                    <option value="animes">üéå Anim√©s</option>
                    <option value="films">üé¨ Films</option>
                    <option value="series">üì∫ S√©ries</option>
                    <option value="favoris">‚ù§Ô∏è Favoris</option>
                </select>
            </div>

            <!-- Sort Filter -->
            <div class="form-group" style="margin-bottom: 0;">
                <label for="sortBy">Trier par</label>
                <select id="sortBy" onchange="render()" style="margin-bottom: 0;">
                    <option value="date_new">üìÖ Plus r√©cent</option>
                    <option value="date_old">üìÖ Plus vieux</option>
                    <option value="rating_high">‚≠ê Mieux not√©</option>
                    <option value="rating_low">‚≠ê Moins not√©</option>
                    <option value="name">üìõ Nom (A-Z)</option>
                </select>
            </div>
        </div>
    </div>

    <!-- TYPE TABS -->
    <div class="type-tabs" style="margin-bottom: 24px;">
        <button class="tab-btn active" onclick="window.switchFilterType('tout')" data-type="tout">üì∫ Tous</button>
        <button class="tab-btn" onclick="window.switchFilterType('animes')" data-type="animes">üéå Anim√©s</button>
        <button class="tab-btn" onclick="window.switchFilterType('films')" data-type="films">üé¨ Films</button>
        <button class="tab-btn" onclick="window.switchFilterType('series')" data-type="series">üì∫ S√©ries</button>
        <button class="tab-btn" onclick="window.switchFilterType('favoris')" data-type="favoris">‚ù§Ô∏è Mes favoris</button>
    </div>
</section>

<!-- FAVORIS SECTION -->
<section id="favoritesSection" style="display: none;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">‚ù§Ô∏è Mes Favoris (<span id="countFavorites">0</span>)</h2>
    </div>
    <div class="grid" id="favoritesList"></div>
</section>

<section>
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h2 style="margin: 0;">üìñ Biblioth√®que (<span id="countItems">0</span>)</h2>
    </div>
    <div class="grid" id="animeList"></div>
</section>
</main>

<script src="site.js"></script>
<script>
    // Recharger les profils et afficher √† chaque acc√®s √† list.html
    window.addEventListener('DOMContentLoaded', function() {
        // Forcer le rechargement des donn√©es depuis localStorage
        if(window.profiles) {
            const p = window.profiles[window.currentProfileIndex || 0];
            if(p) {
                window.animes = p.animes || [];
                window.films = p.films || [];
                window.series = p.series || [];
            }
        }
        
        // Appeler render pour afficher les donn√©es
        if(window.render) {
            window.render();
        }
    });
    
    // Aussi recharger si on revient depuis une autre page (via beforeunload)
    window.addEventListener('pageshow', function() {
        if(window.profiles) {
            const p = window.profiles[window.currentProfileIndex || 0];
            if(p) {
                window.animes = p.animes || [];
                window.films = p.films || [];
                window.series = p.series || [];
            }
        }
        
        if(window.render) {
            window.render();
        }
    });
</script>

</body>
</html>
