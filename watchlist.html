<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CineNote - Ma Watchlist</title>
    <link rel="stylesheet" href="style.css">
</head>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-app.js";
import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.11.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyDWbsbfnF5e-E3rCMguVFF69PpAM-ZlAZ4",
  authDomain: "anime-lo.firebaseapp.com",
  projectId: "anime-lo",
  storageBucket: "anime-lo.firebasestorage.app",
  messagingSenderId: "424542474390",
  appId: "1:424542474390:web:2c28714a4c4f0178daf2b7"
};

try {
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  window.auth = auth;
  window.db = db;
  console.log("âœ… Firebase initialisÃ©");

  window.register = async function(email, password) {
    try {
      await createUserWithEmailAndPassword(auth, email, password);
      try {
        await setDoc(doc(db, "users", auth.currentUser.uid), {
          profiles: [{
            name: "Profil 1",
            avatar: "https://via.placeholder.com/100",
            bio: "",
            animes: [],
            films: [],
            series: [],
            watch: []
          }],
          currentProfileIndex: 0
        });
      } catch(dbError) {
        console.log("Firebase Firestore indisponible, utilisation du stockage local");
        localStorage.setItem("profiles", JSON.stringify([{
          name: "Profil 1",
          avatar: "https://via.placeholder.com/100",
          bio: "",
          animes: [],
          films: [],
          series: [],
          watch: []
        }]));
        localStorage.setItem("currentProfileIndex", "0");
      }
      alert("Compte crÃ©Ã© ! Veuillez complÃ©ter votre profil.");
      window.closeAuthModal();
      window.location.href = "profile-setup.html";
    } catch(e) {
      alert("Erreur: " + e.message);
    }
  };

  window.login = async function(email, password) {
    try {
      await signInWithEmailAndPassword(auth, email, password);
      alert("ConnectÃ© !");
      window.closeAuthModal();
      if(window.loadProfilesFromFirebase) window.loadProfilesFromFirebase();
    } catch(e) {
      alert("Erreur: " + e.message);
    }
  };

  window.logout = async function() {
    try {
      await signOut(auth);
      alert("DÃ©connectÃ©");
      window.updateAuthIcon();
    } catch(e) {
      alert("Erreur: " + e.message);
    }
  };

  window.loadUserData = async function() {
    if(!auth.currentUser) {
      console.log("Utilisateur non connectÃ©");
      return;
    }
    try {
      const ref = doc(db, "users", auth.currentUser.uid);
      const snap = await getDoc(ref);
      if(snap.exists()) {
        window.userDataFromFirebase = snap.data();
        console.log("DonnÃ©es chargÃ©es:", window.userDataFromFirebase);
        if(window.loadProfilesFromFirebase) window.loadProfilesFromFirebase();
      }
    } catch(e) {
      console.error("Erreur chargement:", e);
    }
  };

  onAuthStateChanged(auth, (user) => {
    if(user) {
      console.log("Utilisateur connectÃ©:", user.email);
      window.loadUserData();
      window.updateAuthIcon();
    } else {
      console.log("Utilisateur dÃ©connectÃ©");
      window.updateAuthIcon();
      setTimeout(() => {
        if(window.loadProfilesFromFirebase) {
          window.loadProfilesFromFirebase();
        }
      }, 500);
    }
  });
} catch(e) {
  console.error("âŒ Erreur Firebase:", e);
  window.auth = null;
  window.db = null;
}
</script>
<body>

<header>
    <div>
        <h1>ğŸ¬ CineNote</h1>
    </div>
    <nav>
        <a href="index.html">Accueil</a>
        <a href="search.html">ğŸ” Recherche</a>
        <a href="list.html">Ma BibliothÃ¨que</a>
        <a href="watchlist.html">â³ Watchlist</a>
        <a href="about.html">Ã€ propos</a>
    </nav>
    <div class="header-right">
        <div class="auth-icon" onclick="window.openAuthModal()" id="authIcon">ğŸ‘¤</div>
    </div>
</header>

<main>
<section>
    <h2>â³ Ma Watchlist</h2>
    <p style="color: var(--text-muted); margin-bottom: 24px;">Les titres que tu veux regarder bientÃ´t</p>
    
    <div style="background: var(--bg-lighter); padding: 20px; border-radius: 12px; border: 1px solid var(--border); margin-bottom: 24px;">
        <div style="display: flex; gap: 12px;">
            <input id="watchInput" type="text" placeholder="Ajouter un titre Ã  ta watchlist..." style="flex: 1; margin-bottom: 0;">
            <button class="btn-secondary" onclick="addWatch()" style="width: auto; margin-bottom: 0;">â• Ajouter</button>
        </div>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
        <h3 style="margin: 0;">Titres en attente (<span id="countWatch">0</span>)</h3>
    </div>

    <div class="grid" id="watchList"></div>
    
    <div id="emptyWatch" style="text-align: center; color: var(--text-muted); padding: 40px 20px;">
        <p style="font-size: 18px;">ğŸ˜´ Ta watchlist est vide</p>
        <p>Ajoute des titres que tu veux regarder bientÃ´t !</p>
    </div>
</section>
</main>

<script src="site.js"></script>

</body>
</html>
